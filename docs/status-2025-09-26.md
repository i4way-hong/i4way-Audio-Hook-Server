# 개발 진행 상태 (EOD) - 2025-09-26

## 1. 오늘 완료 항목
- Telemetry 확장
  - `version` 필드(v1) 및 `rtpPacketsReceived` 카운터 추가.
  - `rtp-packet` 이벤트 훅 연결.
- RTP 수신 옵션 기능
  - 환경 변수 `MRCP_ENABLE_RTP_LISTEN=1` 시 임의 UDP 포트 bind → 수신 RTP 헤더(V=2) 패킷 카운트.
  - 세션 객체에 `localPort` (수신 포트) 노출.
- Prometheus 스타일 `/metrics` 엔드포인트
  - `metrics.ts` 레지스트리: 세션 단위 provider 등록/해제.
  - 집계 필드(예: partial/final/fallback/rtspDescribe/setup/sipAttempts 등) 출력.
- Fallback 제어
  - `MRCP_DISABLE_FALLBACK5004` 동작 및 테스트 (`unimrcp-disable-fallback.test.ts`).
- SIP (TCP) INVITE 재시도 로직
  - `MRCP_SIP_INVITE_RETRIES`, `MRCP_SIP_INVITE_TIMEOUT_MS`, 테스트용 `MRCP_TEST_FORCE_SIP_TIMEOUT` 소비.
- 문서/도구
  - SIP 로드맵(`docs/sip-roadmap.md`) 작성.
  - RTP PCMU 샘플 송신 스크립트(`send_rtp_pcmu_example.ts`).

## 2. 현재 코드 구조 핵심
- Signaling 진입: `openSession()` (`unimrcp-signaling.ts`)
  - 순서: (Native 가능 시) → SIP(TCP skeleton) → RTSP(DESCRIBE/SETUP) → (실패) fallback 5004 (비활성화 가능)
- Telemetry: `MrcpTelemetry`
  - 주요 카운터: sipAttempts/sipSuccess/sipFail, rtspDescribeAttempts/fail, rtspSetupAttempts/fail, inviteRetries, inviteTimeouts, fallback5004Count, session transports(sip/rtsp), partialCount/finalCount, rtpPacketsReceived.
  - snapshot version: 1
- Metrics Export: `/metrics` (Prometheus 텍스트)
  - 세션 snapshot 합산 → 카운터 노출
- RTP 수신 (옵션): `MRCP_ENABLE_RTP_LISTEN`
  - UDP 포트 자동 할당 → 패킷 수신 시 `rtp-packet` emit → telemetry 증가

## 3. 진행 중 / 미완료 항목
| 항목 | 상태 | 설명 |
|------|------|------|
| SIP UDP 1단계 (MRCP_ENABLE_SIP_V2) | 미착수 | UDP INVITE/200 OK/ACK 최소 구현 + 재전송(T1 기반) + 실패 시 TCP 또는 RTSP 폴백 전략 결정 필요 (안 A 권장) |
| README / env 문서 업데이트 | 미착수 | 새 플래그(MRCP_ENABLE_RTP_LISTEN, MRCP_ENABLE_SIP_V2), /metrics 사용 예, telemetry version 명시 |
| Metrics & RTP 테스트 | 미착수 | /metrics 출력 스냅샷 테스트 + rtpPacketsReceived 증가 검증 |
| Telemetry version bump (v2) | 예정 | SIP UDP 카운터(sipUdpAttempts/success/fail) 도입 시 버전 2 승격 |

## 4. 내일(다음 작업) 제안 순서
1. SIP UDP 스켈레톤 구현
   - 새 파일 `sip-udp.ts` (dgram 기반)
   - ENV `MRCP_ENABLE_SIP_V2=1` 일 때 UDP 우선
   - 재전송: T1=500ms (예: 0, +500, +1000, +2000, +4000) / Timer B ~ (64*T1) 내 제한
   - 200 OK SDP 파싱 후 ACK 전송 (best-effort)
   - 실패 전략: (안 A) UDP 실패 → 기존 TCP INVITE → 실패 시 RTSP 폴백
2. Telemetry v2 확장
   - 필드: sipUdpAttempts, sipUdpSuccess, sipUdpFail
   - `/metrics` 반영, README & telemetry.md 변경 로그
3. 테스트 추가
   - UDP 모의 SIP 서버 (jest) → INVITE 수신 후 N번째에 200 OK 전송
   - 재전송 카운트 검증 + 성공 시 telemetry 전달
   - rtpPacketsReceived: 테스트에서 세션 localPort 얻어 가짜 RTP 패킷 send
   - /metrics endpoint 내용 스냅샷 (주요 카운터 존재 확인)
4. 문서 업데이트
   - README: 환경 변수 표, /metrics 예시, RTP listen 예시(curl), SIP UDP 주의사항 (MRCP channel 미구현)
   - env.md & telemetry.md: v2 변경 이력
5. (선택) 코드 리팩터링
   - SIP 공통 빌더(helper) 분리 (TCP/UDP 공유)
   - `openSession` 내부 SIP 블록 함수 분리로 가독성 향상

## 5. 리스크 / 주의사항
- UDP 재전송 로직: 타이머 관리 누락 시 메모리 누수 위험 → clearTimeout 구조 설계 필요
- /metrics 합산 시 숫자 필드 외 문자열 혼입 금지 (snapshot 구조 유지)
- Telemetry version 업 후 이전 세션과 호환: `/metrics` 는 합산이므로 누락 필드 0 처리 필요
- RTP listener: 대량 패킷 수신 시 backpressure 없음 → 단순 카운터폭증 가능 (지금은 dev 용이므로 OK)

## 6. 결정 필요 (내일 첫 단계 전)
- UDP 실패 시 폴백 전략: A(UDP→TCP→RTSP) / B(UDP→RTSP) 선택 (현재 제안 = A)
- 재전송 횟수/패턴 고정 or ENV 노출 여부 (초기: 하드코딩 후 필요 시 ENV)

## 7. 참고 ENV 플래그 현황 (현재 코드 기준)
- MRCP_DISABLE_NATIVE
- MRCP_FORCE_RTSP
- MRCP_DISABLE_FALLBACK5004
- MRCP_SIP_INVITE_RETRIES / MRCP_SIP_INVITE_TIMEOUT_MS
- MRCP_TEST_FORCE_SIP_TIMEOUT (테스트 전용 1회성)
- MRCP_RTSP_DESCRIBE_RETRIES / MRCP_RTSP_SETUP_RETRIES
- MRCP_RTP_PORT_MIN / MRCP_RTP_PORT_MAX
- MRCP_ENABLE_RTP_LISTEN (신규)
- (예정) MRCP_ENABLE_SIP_V2 (UDP)

## 8. 빠른 확인 체크리스트 (현재 상태)
- [x] RTSP DESCRIBE/SETUP 기본 동작
- [x] SIP(TCP) skeleton + 재시도
- [x] Telemetry snapshot version=1
- [x] RTP listen 옵션 & 카운터
- [x] /metrics 엔드포인트
- [ ] SIP UDP (v2 flag)
- [ ] README & env 업데이트
- [ ] metrics & RTP 테스트

## 9. 요약
기초 시그널링/텔레메트리/관측성 토대 구축 완료. 다음 단계는 SIP UDP 1단계 구현 및 telemetry v2 확장을 통한 프로토콜 폭 확대. 문서/테스트 보강으로 안정화 예정.

---
(EOD 2025-09-26)
